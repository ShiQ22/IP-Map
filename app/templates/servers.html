{# templates/servers.html #}
{% extends "base.html" %}

{% block title %}Servers{% endblock %}

{% block head %}
  {{ super() }}
  <!-- DataTables CSS -->
  <link 
    href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" 
    rel="stylesheet">
  <link 
    href="https://cdn.datatables.net/rowgroup/1.3.0/css/rowGroup.bootstrap5.min.css" 
    rel="stylesheet">
{% endblock %}

{% block content %}
<div class="main">
  <div class="d-flex mb-3">
    <h2 class="flex-grow-1"><i class="bi bi-server me-1"></i> Servers</h2>
    <button id="addSrv" class="btn btn-primary">
      <i class="bi bi-plus-lg"></i> Add New Server
    </button>
  </div>

  <div class="card">
    <div class="card-body p-0">
      <table id="srvTable" class="table mb-0 w-100">
        <thead class="table-light">
          <tr>
            <th style="display:none">Server</th>
            <th>Location</th>
            <th>Description</th>
            <th>IP</th>
            <th>MAC</th>
            <th>Asset Tag</th>
            <th>Added On</th>
            <th>Updated By</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Add/Edit Modal -->
  <div class="modal fade" id="srvModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add / Edit Server</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <input type="hidden" id="srvId">

          <div class="row mb-3">
            <div class="col">
              <label>Server Name</label>
              <input id="serverName" class="form-control">
            </div>
            <div class="col">
              <label>Location</label>
              <input id="serverLocation" class="form-control">
            </div>
          </div>

          <div class="mb-3">
            <label>Description</label>
            <textarea id="serverDescription" class="form-control" rows="2"></textarea>
          </div>

          <hr>
          <h6>IP Addresses</h6>
          <div id="ipList">
            <!-- default row: IP + MAC + Tag -->
            <div class="row mb-2 ip-row">
              <div class="col-3">
                <input class="form-control ip" placeholder="IP address">
              </div>
              <div class="col-3">
                <input class="form-control mac" placeholder="MAC (optional)">
              </div>
              <div class="col-4">
                <input class="form-control tag" placeholder="Asset Tag (optional)">
              </div>
              <div class="col-2 text-end">
                <button class="btn btn-sm btn-outline-danger remove">×</button>
              </div>
            </div>
          </div>
          <button id="addIpRow" class="btn btn-outline-secondary btn-sm mb-3">
            + Add IP
          </button>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button id="saveSrvAll" class="btn btn-primary">Save Server</button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}

{% raw %}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/rowgroup/1.3.0/js/dataTables.rowGroup.min.js"></script>

<script>
$(function(){
  // append an IP/MAC/Tag row
  function addIpRow(ip='', mac='', tag='') {
    $('#ipList').append(`
      <div class="row mb-2 ip-row">
        <div class="col-3"><input class="form-control ip"  placeholder="IP address"      value="${ip}"></div>
        <div class="col-3"><input class="form-control mac" placeholder="MAC (optional)"    value="${mac}"></div>
        <div class="col-4"><input class="form-control tag" placeholder="Asset Tag (optional)" value="${tag}"></div>
        <div class="col-2 text-end">
          <button class="btn btn-sm btn-outline-danger remove">×</button>
        </div>
      </div>`);
  }

  // remove row
  $(document).on('click','.remove', e => {
    $(e.currentTarget).closest('.ip-row').remove();
  });

  // DataTable with date renderer
  const table = $('#srvTable').DataTable({
    ajax: { url:'/api/servers/flat', dataSrc:'' },
    columns: [
      { data:'server_name', visible:false },
      { data:'location'                 },
      { data:'description'              },
      { data:'ip_address',   title:'IP' },
      { data:'mac_address',  title:'MAC' },
      { data:'asset_tag',    title:'Asset Tag' },
      { data:'added_on',     title:'Added On', render: d =>
          new Date(d).toLocaleString() },
      { data:'updated_by',   title:'Updated By' },
      { data:null, orderable:false, render: r => `
        <button class="btn btn-sm btn-warning me-1"
                onclick="openSrvEdit(${r.server_id})">
          <i class="bi bi-pencil"></i>
        </button>
        <button class="btn btn-sm btn-danger"
                onclick="deleteServerIp(${r.ip_id})">
          <i class="bi bi-trash"></i>
        </button>` }
    ],
    order:[[0,'asc']],
    rowGroup:{
      dataSrc:'server_name',
      startRender:(rows,name)=>{
        const loc = rows.data().pluck('location')[0];
        return `
          <tr class="table-secondary">
            <td colspan="8" class="fw-bold">${name} — ${loc}</td>
          </tr>`;
      },
      endRender:null
    }
  });

  // show blank modal
  $('#addSrv').click(()=>{
    $('#srvId').val('');
    $('#serverName,#serverLocation,#serverDescription').val('');
    $('#ipList').empty();
    addIpRow();
    $('#saveSrvAll').off().click(saveServer);
    new bootstrap.Modal('#srvModal').show();
  });

  // add extra rows
  $('#addIpRow').click(()=> addIpRow());

  // save server (create or update)
  async function saveServer(){
    const sid = $('#srvId').val();
    const meta = {
      server_name: $('#serverName').val().trim(),
      location:    $('#serverLocation').val().trim(),
      description: $('#serverDescription').val().trim() || null
    };

    // 1) POST or PUT
    const url = sid ? `/api/servers/${sid}` : '/api/servers';
    const method = sid ? 'PUT' : 'POST';
    let resp = await fetch(url,{
      method, headers:{'Content-Type':'application/json'},
      body:JSON.stringify(meta)
    });
    const data = await resp.json();
    if (!resp.ok){
      alert(data.detail||data.error||'Failed saving server');
      return;
    }
    const server = data;

    // 2) collect IP entries
    const newIps = $('.ip-row').map((_,r)=>{
      const $r=$(r);
      return {
        ip_address:  $r.find('.ip').val().trim(),
        mac_address: $r.find('.mac').val().trim() || null,
        asset_tag:   $r.find('.tag').val().trim() || null
      };
    }).get().filter(x=>x.ip_address);

    // 3) attach IPs
    if (newIps.length){
      resp = await fetch(`/api/servers/${server.id}/ips`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(newIps)
      });
      if (!resp.ok){
        const err = await resp.json();
        alert(err.detail||'Failed saving IPs');
      }
    }

    $('#srvModal').modal('hide');
    table.ajax.reload();
  }

  // load for edit
  window.openSrvEdit = async sid => {
    const s = await fetch(`/api/servers/${sid}`)
                .then(r=>r.json());
    $('#srvId').val(s.id);
    $('#serverName').val(s.server_name);
    $('#serverLocation').val(s.location);
    $('#serverDescription').val(s.description||'');
    $('#ipList').empty();
    s.ips.forEach(ip=> addIpRow(ip.ip_address, ip.mac_address, ip.asset_tag));
    $('#saveSrvAll').off().click(saveServer);
    new bootstrap.Modal('#srvModal').show();
  };

  // delete IP
  window.deleteServerIp = ipId => {
    if (!confirm('Delete this IP?')) return;
    fetch(`/api/servers/ips/${ipId}`, { method:'DELETE' })
      .then(_=> table.ajax.reload());
  };
});
</script>
{% endraw %}
{% endblock %}
